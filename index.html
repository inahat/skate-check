<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skatepark Dryness Checker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        #status-circle {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            transition: background-color 0.5s ease;
            border: 4px solid rgba(255,255,255,0.1);
        }

        #status-text {
            font-size: 2.5rem;
            font-weight: 800;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #sub-status {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
            font-weight: 500;
        }

        h1 { margin-bottom: 10px; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; color: #888; }
        
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
            max-width: 320px;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .data-item { display: flex; flex-direction: column; align-items: center; }
        .data-label { font-size: 0.75rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .data-value { font-size: 1.3rem; font-weight: 700; }

        button {
            margin-top: 30px;
            padding: 18px 40px;
            font-size: 1rem;
            font-weight: bold;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        #message { margin-top: 20px; font-size: 1.1rem; color: #ddd; max-width: 300px; line-height: 1.5; min-height: 1.5em;}
        #loading { color: #888; margin-top: 15px; font-size: 0.9rem; min-height: 1.2em; }
        
        .footer { margin-top: 40px; font-size: 0.7rem; color: #555; }
    </style>
</head>
<body>

    <h1>Skate Condition</h1>

    <div id="status-circle">
        <span id="status-text">?</span>
        <span id="sub-status">Ready</span>
    </div>

    <div id="message">Click check to analyze local dew point.</div>
    <div id="loading"></div>

    <div class="data-grid" id="dashboard" style="opacity: 0.3;">
        <div class="data-item">
            <span class="data-label">Air Temp</span>
            <span class="data-value" id="temp-val">--</span>
        </div>
        <div class="data-item">
            <span class="data-label">Dew Point</span>
            <span class="data-value" id="dew-val">--</span>
        </div>
        <div class="data-item">
            <span class="data-label">Spread</span>
            <span class="data-value" id="spread-val">--</span>
        </div>
        <div class="data-item">
            <span class="data-label">Rain (3h)</span>
            <span class="data-value" id="rain-val">--</span>
        </div>
    </div>

    <button onclick="getLocation()">CHECK NOW</button>

    <div class="footer">Using Open-Meteo Data</div>

    <script>
        function getLocation() {
            const loading = document.getElementById('loading');
            loading.innerText = "Acquiring GPS location...";
            document.getElementById('message').innerText = "Analyzing...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(fetchWeather, showError);
            } else {
                loading.innerText = "Geolocation not supported.";
            }
        }

        function showError(error) {
            let msg = "Error.";
            if(error.code == 1) msg = "Please allow location access.";
            document.getElementById('loading').innerText = msg;
        }

        async function fetchWeather(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const loading = document.getElementById('loading');
            
            loading.innerText = "Fetching satellite data...";

            // Open-Meteo API: Forecast + Past 1 day for rain history
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,dew_point_2m,precipitation,rain,wind_speed_10m,cloud_cover&hourly=precipitation&past_days=1&forecast_days=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                calculateSkateability(data);
            } catch (err) {
                loading.innerText = "API Error. Try again.";
                console.error(err);
            }
        }

        function calculateSkateability(data) {
            const current = data.current;
            const hourly = data.hourly;

            // 1. Get Values
            const temp = current.temperature_2m;
            const dew = current.dew_point_2m;
            const spread = (temp - dew).toFixed(1);
            
            // 2. Calc Rain History (Last 3 hours)
            const nowISO = new Date().toISOString().slice(0, 13);
            let idx = hourly.time.findIndex(t => t.startsWith(nowISO));
            if (idx === -1) idx = hourly.time.length - 1;

            let rainSum = 0;
            // Sum previous 3 hours
            for (let i = 0; i < 3; i++) {
                if (idx - i >= 0) rainSum += hourly.precipitation[idx - i];
            }
            rainSum = rainSum.toFixed(1);

            // 3. Logic Tree
            let status = "DRY";
            let sub = "GO SKATE";
            let color = "#2ecc71"; // Green
            let msg = "High spread between temp and dew point.";

            // Logic A: Is it raining now?
            if (current.precipitation > 0) {
                status = "WET";
                sub = "RAINING";
                color = "#e74c3c"; // Red
                msg = "Active precipitation detected.";
            }
            // Logic B: Did it rain recently?
            else if (rainSum > 0.2) {
                if (current.wind_speed_10m > 15 && rainSum < 1.0) {
                    status = "MAYBE";
                    sub = "WINDY";
                    color = "#f39c12"; // Orange
                    msg = "Recent rain, but high wind might be drying it.";
                } else {
                    status = "WET";
                    sub = "SOAKED";
                    color = "#e74c3c";
                    msg = `It rained ${rainSum}mm in the last 3 hours.`;
                }
            }
            // Logic C: Dew Point (The invisible killer)
            else if (spread < 1.0) {
                status = "NO";
                sub = "DEW";
                color = "#e74c3c"; // Red
                msg = `Dew Point spread is only ${spread}°C. Ground is sweating.`;
            }
            else if (spread < 2.5) {
                status = "RISKY";
                sub = "DAMP";
                color = "#f39c12"; // Orange
                msg = `Spread is low (${spread}°C). Bowls likely slippery.`;
            }
            else if (spread < 4.0 && current.cloud_cover < 20) {
                 // Clear skies at night = faster ground cooling
                 let hour = new Date().getHours();
                 if(hour < 8 || hour > 19) {
                    status = "IFFY";
                    sub = "COLD GND";
                    color = "#f39c12";
                    msg = "Clear skies at night = Cold ground. Watch for hidden dew.";
                 }
            }

            // 4. Update UI
            const circle = document.getElementById('status-circle');
            circle.style.backgroundColor = color;
            document.getElementById('status-text').innerText = status;
            document.getElementById('sub-status').innerText = sub;
            document.getElementById('message').innerText = msg;
            document.getElementById('loading').innerText = "";

            document.getElementById('dashboard').style.opacity = "1";
            document.getElementById('temp-val').innerText = temp + "°";
            document.getElementById('dew-val').innerText = dew + "°";
            document.getElementById('spread-val').innerText = spread + "°";
            document.getElementById('rain-val').innerText = rainSum + "mm";
        }
    </script>
</body>
</html>
